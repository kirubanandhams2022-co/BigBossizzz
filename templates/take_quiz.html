{% extends "base.html" %}

{% block title %}Taking Quiz - {{ quiz.title }} - Proctoring Platform{% endblock %}

{% block extra_head %}
<style>
.quiz-container {
    max-width: 800px;
    margin: 0 auto;
}
.question-card {
    margin-bottom: 2rem;
}
.time-warning {
    animation: pulse 1s infinite;
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
.proctoring-status {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1000;
}

/* Mobile-specific styles */
@media (max-width: 768px) {
    .quiz-container {
        max-width: 100%;
        padding: 10px;
        margin: 0;
    }
    
    .question-card {
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }
    
    .proctoring-status {
        position: fixed;
        top: 60px;
        left: 10px;
        right: 10px;
        text-align: center;
    }
    
    .proctoring-status .alert {
        padding: 8px;
        font-size: 0.9rem;
    }
    
    /* Hide background to prevent distractions */
    body {
        background: #000 !important;
    }
    
    .container, .quiz-container {
        background: #fff;
        border-radius: 0;
    }
    
    /* Larger touch targets for mobile */
    .form-check-input {
        transform: scale(1.5);
        margin-right: 15px;
    }
    
    .form-check-label {
        margin-left: 10px;
        line-height: 1.6;
    }
    
    .btn {
        padding: 12px 20px;
        font-size: 1.1rem;
        border-radius: 8px;
    }
    
    textarea.form-control {
        font-size: 1.1rem;
        padding: 15px;
    }
}

/* Tablet-specific styles */
@media (min-width: 768px) and (max-width: 1024px) {
    .quiz-container {
        max-width: 90%;
        padding: 15px;
    }
    
    .question-card {
        font-size: 1.05rem;
    }
}

/* Security overlay styles */
.mobile-security-warning {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #dc3545;
    color: white;
    padding: 10px;
    text-align: center;
    z-index: 9999;
    display: none;
}

.mobile-security-warning.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { transform: translateY(-100%); }
    to { transform: translateY(0); }
}
</style>
{% endblock %}

{% block content %}
{% if quiz.proctoring_enabled %}
<div class="proctoring-status">
    <div class="alert alert-danger" id="proctoring-status-alert">
        <i class="fas fa-shield-alt"></i> <strong>SMART SECURITY MONITORING ACTIVE</strong>
        <br><small>Live monitoring ‚Ä¢ Camera + Audio ‚Ä¢ Environment analysis ‚Ä¢ Activity detection</small>
    </div>
</div>

<!-- Security Check Panel -->
<div class="modal fade" id="securityCheckModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">üîí Security Check Required</h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> Before starting this proctored quiz:</h6>
                </div>
                
                <div class="checklist">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="check-camera">
                        <label class="form-check-label" for="check-camera">
                            üì∑ Camera access granted and working
                        </label>
                    </div>
                    <div class="form-check mb-3" id="microphone-check">
                        <input class="form-check-input" type="checkbox" id="check-microphone">
                        <label class="form-check-label" for="check-microphone">
                            üé§ Microphone access granted for environment monitoring
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="check-tabs">
                        <label class="form-check-label" for="check-tabs">
                            üìë All other browser tabs and applications closed
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="check-fullscreen">
                        <label class="form-check-label" for="check-fullscreen">
                            üñ•Ô∏è Ready to enter fullscreen mode
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="check-environment">
                        <label class="form-check-label" for="check-environment">
                            üè† Private, quiet environment (no other people visible)
                        </label>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è Monitoring Notice:</strong> All activities are monitored and logged for review.
                    <ul class="mt-2 mb-0">
                        <li>Multiple people in camera view will be detected</li>
                        <li>Frequent looking away is monitored</li>
                        <li>Tab and application switching is tracked</li>
                        <li>Camera covering or disabling is detected</li>
                        <li>Background conversations are analyzed</li>
                        <li>Unusual audio activity is logged</li>
                    </ul>
                    <small class="text-muted">Note: Monitoring focuses on detection and logging. Excessive violations may result in quiz review.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="start-secure-quiz" disabled>
                    <i class="fas fa-play"></i> Start Secure Quiz
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="quiz-container">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3><i class="fas fa-clipboard-list"></i> {{ quiz.title }}</h3>
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-clock"></i>
                        <span id="timer" class="fw-bold">{{ quiz.time_limit }}:00</span>
                    </div>
                    <div>
                        <span class="badge bg-primary">{{ questions|length }} Questions</span>
                    </div>
                </div>
            </div>
        </div>
        
        <form id="quizForm" method="POST" action="{{ url_for('submit_quiz', attempt_id=attempt.id) }}">
            <div class="card-body">
                {% if quiz.description %}
                    <div class="alert alert-light">
                        <i class="fas fa-info-circle"></i>
                        {{ quiz.description }}
                    </div>
                {% endif %}
                
                {% if quiz.proctoring_enabled %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Proctoring Notice:</strong> This quiz is being monitored. Avoid switching tabs, opening other applications, or leaving the quiz window.
                    </div>
                {% endif %}
                
                <div class="progress mb-4">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar">
                        <span id="progressText">0 of {{ questions|length }} answered</span>
                    </div>
                </div>
                
                {% for question in questions %}
                <div class="question-card card mb-4">
                    <div class="card-header">
                        <h5>
                            <span class="badge bg-secondary me-2">Q{{ loop.index }}</span>
                            {{ question.question_text }}
                            <span class="badge bg-primary ms-2">{{ question.points }} pts</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if question.question_type == 'multiple_choice' %}
                            {% for option in question.options|sort(attribute='order') %}
                            <div class="form-check mb-2">
                                <input class="form-check-input question-input" type="radio" 
                                       name="question_{{ question.id }}" 
                                       value="{{ option.id }}" 
                                       id="q{{ question.id }}_{{ option.id }}"
                                       {% if existing_answers.get(question.id) and existing_answers[question.id].selected_option_id == option.id %}checked{% endif %}
                                       onchange="updateProgress()">
                                <label class="form-check-label" for="q{{ question.id }}_{{ option.id }}">
                                    {{ option.option_text }}
                                </label>
                            </div>
                            {% endfor %}
                            
                        {% elif question.question_type == 'true_false' %}
                            {% for option in question.options|sort(attribute='order') %}
                            <div class="form-check mb-2">
                                <input class="form-check-input question-input" type="radio" 
                                       name="question_{{ question.id }}" 
                                       value="{{ option.id }}" 
                                       id="q{{ question.id }}_{{ option.id }}"
                                       {% if existing_answers.get(question.id) and existing_answers[question.id].selected_option_id == option.id %}checked{% endif %}
                                       onchange="updateProgress()">
                                <label class="form-check-label" for="q{{ question.id }}_{{ option.id }}">
                                    {{ option.option_text }}
                                </label>
                            </div>
                            {% endfor %}
                            
                        {% elif question.question_type == 'text' %}
                            <textarea class="form-control question-input" 
                                      name="question_{{ question.id }}" 
                                      rows="4" 
                                      placeholder="Enter your answer here..."
                                      onchange="updateProgress()">{% if existing_answers.get(question.id) %}{{ existing_answers[question.id].text_answer or '' }}{% endif %}</textarea>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="card-footer">
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" onclick="saveDraft()">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button type="submit" class="btn btn-success" onclick="return confirmSubmit()">
                        <i class="fas fa-paper-plane"></i> Submit Quiz
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="submitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit your quiz? Once submitted, you cannot make any changes.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span id="submissionSummary"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitQuiz()">
                    <i class="fas fa-paper-plane"></i> Submit Quiz
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/quiz.js') }}"></script>
{% if quiz.proctoring_enabled %}
<!-- Load appropriate proctoring script based on device type -->
{% if device_type == 'desktop' %}
<script src="{{ url_for('static', filename='js/enhanced-proctoring.js') }}"></script>
{% else %}
<script src="{{ url_for('static', filename='js/mobile-proctoring.js') }}"></script>
{% endif %}
<script>
// Proctoring Integration - Device Aware
let enhancedProctoring = null;
let mobileProctoringManager = null;
let securityCheckPassed = false;

// Security Check Modal Logic
document.addEventListener('DOMContentLoaded', function() {
    const securityModal = new bootstrap.Modal(document.getElementById('securityCheckModal'));
    const startButton = document.getElementById('start-secure-quiz');
    const checkboxes = document.querySelectorAll('#securityCheckModal .form-check-input');
    
    // Show security check modal on page load if proctoring is enabled
    {% if quiz.proctoring_enabled %}
    // Customize security checks for mobile devices
    const deviceType = '{{ device_type|default("desktop") }}';
    if (deviceType === 'mobile' || deviceType === 'tablet') {
        // Hide microphone check for mobile (we don't use audio recording)
        const micCheck = document.getElementById('microphone-check');
        if (micCheck) micCheck.style.display = 'none';
    }
    
    securityModal.show();
    {% endif %}
    
    // Enable start button only when all checks are completed
    function updateStartButton() {
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        startButton.disabled = !allChecked;
    }
    
    checkboxes.forEach(cb => cb.addEventListener('change', updateStartButton));
    
    // Start secure quiz process - device aware
    startButton.addEventListener('click', async function() {
        try {
            const deviceType = '{{ device_type|default("desktop") }}';
            
            if (deviceType === 'mobile' || deviceType === 'tablet') {
                // Initialize mobile proctoring system
                if (typeof MobileProctoringManager !== 'undefined') {
                    mobileProctoringManager = new MobileProctoringManager({{ attempt.id }}, deviceType);
                } else {
                    console.error('MobileProctoringManager not available');
                }
            } else {
                // Initialize desktop enhanced proctoring system
                if (typeof EnhancedProctoringSystem !== 'undefined') {
                    enhancedProctoring = new EnhancedProctoringSystem({{ attempt.id }}, {{ quiz.id }});
                    
                    // Start camera monitoring
                    await enhancedProctoring.startLiveCameraMonitoring();
                    
                    // Activate do not disturb mode
                    enhancedProctoring.activateDoNotDisturbMode();
                } else {
                    console.error('EnhancedProctoringSystem not available');
                }
            }
            
            // Hide security modal
            securityModal.hide();
            
            // Remove lockdown overlay and show quiz content
            setTimeout(() => {
                const lockdown = document.getElementById('proctoring-lockdown');
                if (lockdown) {
                    lockdown.querySelector('#lockdown-status').textContent = 'Quiz started - Security monitoring active';
                    lockdown.style.display = 'none';
                }
                
                // Start the quiz timer
                startTimer();
                securityCheckPassed = true;
                
                // Update proctoring status
                const statusAlert = document.getElementById('proctoring-status-alert');
                if (statusAlert) {
                    statusAlert.className = 'alert alert-success';
                    statusAlert.innerHTML = '<i class="fas fa-shield-check"></i> <strong>SECURITY ACTIVE</strong><br><small>Camera monitoring ‚Ä¢ Real-time analysis ‚Ä¢ No violations detected</small>';
                }
                
            }, 1000);
            
        } catch (error) {
            console.error('Failed to start secure quiz:', error);
            // REMOVED: alert popup replaced with toast
            this.showSingleWarning('Failed to start secure mode. Please check camera permissions and try again.');
        }
    });
});

// Old proctoring system disabled - using enhanced system only

// Override quiz submission to include enhanced proctoring data
function submitQuiz() {
    if (enhancedProctoring && enhancedProctoring.isActive) {
        // Stop monitoring before submission
        enhancedProctoring.stopMonitoring();
    }
    
    // Submit the quiz form
    document.getElementById('quizForm').submit();
}

// Global function for automatic submission (called by timer or violations)
function submitQuizAutomatically(reason = 'time_expired') {
    if (enhancedProctoring && enhancedProctoring.isActive) {
        enhancedProctoring.stopMonitoring();
    }
    
    // Add reason to form
    const reasonInput = document.createElement('input');
    reasonInput.type = 'hidden';
    reasonInput.name = 'submission_reason';
    reasonInput.value = reason;
    document.getElementById('quizForm').appendChild(reasonInput);
    
    document.getElementById('quizForm').submit();
}
</script>
{% endif %}

<script>
// Initialize quiz timer
let timeRemaining = {{ quiz.time_limit }} * 60; // Convert to seconds
let timer;

function startTimer() {
    timer = setInterval(function() {
        timeRemaining--;
        
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const display = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        
        document.getElementById('timer').textContent = display;
        
        // Warning when 5 minutes remaining (no popup)
        if (timeRemaining === 300) {
            document.getElementById('timer').classList.add('time-warning', 'text-warning');
            console.warn('Warning: 5 minutes remaining!');
            // Show subtle notification instead of alert
            showQuietNotification('‚è∞ 5 minutes remaining', 'warning');
        }
        
        // Critical warning when 1 minute remaining (no popup)
        if (timeRemaining === 60) {
            document.getElementById('timer').classList.add('text-danger');
            console.warn('Critical: 1 minute remaining!');
            showQuietNotification('üö® 1 minute remaining!', 'danger');
        }
        
        // Auto-submit when time runs out (no popup)
        if (timeRemaining <= 0) {
            clearInterval(timer);
            console.log('Time up! Auto-submitting quiz.');
            showQuietNotification('‚è∞ Time up! Submitting quiz...', 'info');
            setTimeout(() => {
                document.getElementById('quizForm').submit();
            }, 1000);
        }
    }, 1000);
}

function updateProgress() {
    const totalQuestions = {{ questions|length }};
    let answeredQuestions = 0;
    
    // Count answered questions
    const questionInputs = document.querySelectorAll('.question-input');
    const answeredInputs = new Set();
    
    questionInputs.forEach(input => {
        if (input.type === 'radio' && input.checked) {
            answeredInputs.add(input.name);
        } else if (input.type === 'textarea' && input.value.trim()) {
            answeredInputs.add(input.name);
        }
    });
    
    answeredQuestions = answeredInputs.size;
    const percentage = (answeredQuestions / totalQuestions) * 100;
    
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressText').textContent = answeredQuestions + ' of ' + totalQuestions + ' answered';
    
    if (percentage === 100) {
        document.getElementById('progressBar').classList.add('bg-success');
    } else {
        document.getElementById('progressBar').classList.remove('bg-success');
    }
}

function confirmSubmit() {
    const totalQuestions = {{ questions|length }};
    let answeredQuestions = 0;
    
    // Count answered questions
    const questionInputs = document.querySelectorAll('.question-input');
    const answeredInputs = new Set();
    
    questionInputs.forEach(input => {
        if (input.type === 'radio' && input.checked) {
            answeredInputs.add(input.name);
        } else if (input.type === 'textarea' && input.value.trim()) {
            answeredInputs.add(input.name);
        }
    });
    
    answeredQuestions = answeredInputs.size;
    const unanswered = totalQuestions - answeredQuestions;
    
    document.getElementById('submissionSummary').textContent = 
        `You have answered ${answeredQuestions} out of ${totalQuestions} questions.` +
        (unanswered > 0 ? ` ${unanswered} questions remain unanswered.` : '');
    
    // Show confirmation modal
    const submitModal = new bootstrap.Modal(document.getElementById('submitModal'));
    submitModal.show();
    
    return false; // Prevent form submission
}

function submitQuiz() {
    // Hide modal and submit form
    const submitModal = bootstrap.Modal.getInstance(document.getElementById('submitModal'));
    submitModal.hide();
    clearInterval(timer);
    document.getElementById('quizForm').submit();
}

function saveDraft() {
    // This would save the current answers as a draft
    console.log('Draft saved successfully');
    showQuietNotification('üíæ Draft saved!', 'success');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    startTimer();
    updateProgress();
    
    // Auto-save every 30 seconds
    setInterval(saveDraft, 30000);
    
    // Initialize mobile proctoring warning but don't auto-start
    const deviceType = '{{ device_type|default("desktop") }}';
    if (deviceType === 'mobile' || deviceType === 'tablet') {
        console.log('Mobile device detected:', deviceType);
        showMobileSecurityWarning();
    }
});

// Mobile security warning
function showMobileSecurityWarning() {
    const deviceType = '{{ device_type }}';
    const warningDiv = document.createElement('div');
    warningDiv.className = 'mobile-security-warning show';
    warningDiv.innerHTML = `
        <i class="fas fa-shield-alt"></i>
        <strong>MOBILE SECURE MODE ACTIVE</strong>
        - Camera enforced, Screenshots blocked, Background apps monitored
    `;
    
    document.body.insertBefore(warningDiv, document.body.firstChild);
    
    // Hide after 5 seconds
    setTimeout(() => {
        warningDiv.classList.remove('show');
        setTimeout(() => {
            if (warningDiv.parentNode) {
                warningDiv.parentNode.removeChild(warningDiv);
            }
        }, 300);
    }, 5000);
}

// Warn before leaving page
window.addEventListener('beforeunload', function(e) {
    e.preventDefault();
    e.returnValue = 'Are you sure you want to leave? Your progress may be lost.';
});

// Quiet notification function (no interruptions)
function showQuietNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const colors = {
        info: '#17a2b8',
        success: '#28a745', 
        warning: '#ffc107',
        danger: '#dc3545'
    };
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${colors[type]};
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        z-index: 9999;
        font-size: 13px;
        opacity: 0.9;
        transition: opacity 0.3s;
        text-align: center;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Fade out and remove
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) notification.remove();
        }, 300);
    }, 2000);
}
</script>
{% endblock %}
