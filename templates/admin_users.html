{% extends "base.html" %}

{% block title %}User Management - Admin Portal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-users"></i> User Management</h1>
    <div class="btn-group">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
            <i class="fas fa-user-plus"></i> Create User
        </button>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bulkCreateModal">
            <i class="fas fa-users"></i> Bulk Create
        </button>
        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#excelUploadModal">
            <i class="fas fa-file-excel"></i> Excel Upload
        </button>
        <button type="button" class="btn btn-danger" id="bulkDeleteBtn" onclick="bulkDeleteUsers()" disabled>
            <i class="fas fa-trash"></i> Delete Selected (<span id="selectedCount">0</span>)
        </button>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Dashboard
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-list"></i> All Users</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            <label for="selectAll" class="ms-1">Select All</label>
                        </th>
                        <th>#</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr class="{% if not user.is_active %}table-secondary{% endif %}">
                        <td>
                            {% if user.id != current_user.id %}
                            <input type="checkbox" class="user-checkbox" value="{{ user.id }}" onchange="updateBulkDeleteButton()">
                            {% else %}
                            <i class="fas fa-lock text-muted" title="Cannot select your own account"></i>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-secondary">{{ loop.index }}</span></td>
                        <td>
                            <strong>{{ user.username }}</strong>
                            {% if user.id == current_user.id %}<span class="badge bg-info ms-1">You</span>{% endif %}
                        </td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="badge 
                                {% if user.role == 'admin' %}bg-danger
                                {% elif user.role == 'host' %}bg-primary
                                {% else %}bg-success{% endif %}">
                                {{ user.role.title() }}
                            </span>
                        </td>
                        <td>
                            {% if user.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                            {% if not user.is_verified %}
                                <span class="badge bg-warning ms-1">Unverified</span>
                            {% endif %}
                        </td>
                        <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                        <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
                        <td>
                            {% if user.id != current_user.id %}
                            <div class="btn-group btn-group-sm">
                                <!-- Toggle Status -->
                                <form method="POST" action="{{ url_for('admin_toggle_user_status', user_id=user.id) }}" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-outline-{% if user.is_active %}warning{% else %}success{% endif %}" 
                                            onclick="return confirm('Are you sure?')">
                                        <i class="fas fa-{% if user.is_active %}pause{% else %}play{% endif %}"></i>
                                    </button>
                                </form>
                                
                                <!-- Change Role -->
                                <button type="button" class="btn btn-outline-primary" 
                                        onclick="showRoleModal({{ user.id }}, '{{ user.username }}', '{{ user.role }}')">
                                    <i class="fas fa-user-cog"></i>
                                </button>
                                
                                <!-- Edit Credentials -->
                                <button type="button" class="btn btn-outline-info" 
                                        onclick="showCredentialModal({{ user.id }}, '{{ user.username }}', '{{ user.email }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                
                                <!-- Reset Password -->
                                <button type="button" class="btn btn-outline-warning" 
                                        onclick="showPasswordModal({{ user.id }}, '{{ user.username }}')">
                                    <i class="fas fa-key"></i>
                                </button>
                                
                                <!-- Delete User -->
                                <form method="POST" action="{{ url_for('admin_delete_user', user_id=user.id) }}" style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to permanently delete this user and all their data?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-outline-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                            {% else %}
                            <span class="text-muted">Self</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_create_user') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" name="username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" name="password" class="form-control" id="create-password-input" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('create-password-input', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select name="role" class="form-select" required>
                            <option value="participant">Participant</option>
                            <option value="host">Host</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Role Modal -->
<div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-cog"></i> Change User Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="roleForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <p>Change role for user: <strong id="roleUsername"></strong></p>
                    <div class="mb-3">
                        <label class="form-label">New Role</label>
                        <select name="role" id="roleSelect" class="form-select" required>
                            <option value="participant">Participant</option>
                            <option value="host">Host</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Role</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Credentials Modal -->
<div class="modal fade" id="credentialModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit User Credentials</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="credentialForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <p>Edit credentials for: <strong id="credentialUsername"></strong></p>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" name="username" id="credentialUsernameInput" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" id="credentialEmailInput" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password (optional)</label>
                        <div class="input-group">
                            <input type="password" name="password" class="form-control" id="edit-password-input" minlength="6" 
                                   placeholder="Leave empty to keep current password">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('edit-password-input', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">Only enter if you want to change the password</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Credentials</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-key"></i> Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="passwordForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <p>Reset password for user: <strong id="passwordUsername"></strong></p>
                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <div class="input-group">
                            <input type="password" name="new_password" class="form-control" id="reset-password-input" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('reset-password-input', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Reset Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Create Users Modal -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-users"></i> Bulk Create Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_bulk_create_users') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Format:</strong> Enter one user per line in this format:<br>
                        <code>username,email,password,role,courses</code><br>
                        <small><strong>Optional fields:</strong> password, role, courses (semicolon-separated course codes like DSA;MATH)<br>
                        <strong>Course Assignment:</strong> Use course codes separated by semicolons, or leave empty to use default course below.</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Default Role for Users</label>
                                <select name="default_role" class="form-select">
                                    <option value="participant">Participant</option>
                                    <option value="host">Host</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Default Course (Optional)</label>
                                <select name="default_course" class="form-select">
                                    <option value="">No Course Assignment</option>
                                    {% for course in courses %}
                                        <option value="{{ course.code }}">{{ course.code }} - {{ course.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Users will be assigned to this course unless specified per line</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="auto_create_courses" id="autoCreateCourses">
                            <label class="form-check-label" for="autoCreateCourses">
                                Auto-create missing courses
                            </label>
                            <small class="form-text text-muted d-block">If enabled, courses that don't exist will be automatically created with the course code as the name</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">User Data</label>
                        <textarea name="users_data" class="form-control" rows="10" placeholder="student1,student1@example.com,password123,participant,DSA;MATH
student2,student2@example.com,,participant,DSA
teacher1,teacher1@example.com,teacherpass,host,DSA
admin1,admin1@example.com,adminpass,admin," required></textarea>
                        <small class="text-muted">Examples:<br>
                        • <code>student1,student1@example.com,password123,participant,DSA;MATH</code> (assign to DSA and MATH courses)<br>
                        • <code>student2,student2@example.com,,participant,DSA</code> (auto-generated password, assign to DSA)<br>
                        • <code>teacher1,teacher1@example.com,teacherpass,host,</code> (empty courses = use default course)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Users</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Excel Upload Modal -->
<div class="modal fade" id="excelUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-excel"></i> Upload Excel File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_upload_users_excel') }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Excel Format:</strong> Your Excel file should have columns:<br>
                        <strong>Required:</strong> <code>username</code>, <code>email</code><br>
                        <strong>Optional:</strong> <code>password</code>, <code>role</code>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Excel File</label>
                        <input type="file" name="excel_file" class="form-control" accept=".xlsx,.xls" required>
                        <small class="text-muted">Supported formats: .xlsx, .xls</small>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Excel Template Example:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>username</th>
                                        <th>email</th>
                                        <th>password</th>
                                        <th>role</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>student1</td>
                                        <td>student1@example.com</td>
                                        <td>password123</td>
                                        <td>participant</td>
                                    </tr>
                                    <tr>
                                        <td>teacher1</td>
                                        <td>teacher1@example.com</td>
                                        <td></td>
                                        <td>host</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <small class="text-muted">Empty password cells will get auto-generated passwords</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">Upload & Create Users</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function showRoleModal(userId, username, currentRole) {
    document.getElementById('roleUsername').textContent = username;
    document.getElementById('roleSelect').value = currentRole;
    document.getElementById('roleForm').action = `/admin/user/${userId}/change-role`;
    new bootstrap.Modal(document.getElementById('roleModal')).show();
}

function showCredentialModal(userId, username, email) {
    document.getElementById('credentialUsername').textContent = username;
    document.getElementById('credentialUsernameInput').value = username;
    document.getElementById('credentialEmailInput').value = email;
    document.getElementById('credentialForm').action = `/admin/user/${userId}/edit-credentials`;
    new bootstrap.Modal(document.getElementById('credentialModal')).show();
}

function showPasswordModal(userId, username) {
    document.getElementById('passwordUsername').textContent = username;
    document.getElementById('passwordForm').action = `/admin/user/${userId}/reset-password`;
    new bootstrap.Modal(document.getElementById('passwordModal')).show();
}

function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Bulk Delete Functions
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.user-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBulkDeleteButton();
}

function updateBulkDeleteButton() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const selectedCount = document.getElementById('selectedCount');
    
    selectedCount.textContent = checkboxes.length;
    bulkDeleteBtn.disabled = checkboxes.length === 0;
    
    // Update select all checkbox
    const allCheckboxes = document.querySelectorAll('.user-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    if (checkboxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkboxes.length === allCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function bulkDeleteUsers() {
    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
    
    if (selectedIds.length === 0) {
        alert('Please select at least one user to delete.');
        return;
    }
    
    const userCount = selectedIds.length;
    const confirmMessage = `Are you sure you want to delete ${userCount} user${userCount > 1 ? 's' : ''}? This action cannot be undone.`;
    
    if (confirm(confirmMessage)) {
        // Create a form to submit the deletion request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin_bulk_delete_users") }}';
        
        // CSRF token will be added when Flask-WTF is properly configured
        
        // Add selected user IDs
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'user_ids';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Add long press functionality for mobile and desktop double-click
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    let pressTimer;
    
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        
        // Desktop: Double-click to toggle
        row.addEventListener('dblclick', function(e) {
            if (e.target.type !== 'checkbox' && !e.target.closest('button')) {
                checkbox.checked = !checkbox.checked;
                updateBulkDeleteButton();
            }
        });
        
        // Mobile: Long press to toggle
        row.addEventListener('touchstart', function(e) {
            if (e.target.type !== 'checkbox' && !e.target.closest('button')) {
                pressTimer = window.setTimeout(function() {
                    checkbox.checked = !checkbox.checked;
                    updateBulkDeleteButton();
                    
                    // Add visual feedback
                    row.classList.add('table-warning');
                    setTimeout(() => row.classList.remove('table-warning'), 200);
                }, 500);
            }
        });
        
        row.addEventListener('touchend', function() {
            clearTimeout(pressTimer);
        });
        
        row.addEventListener('touchmove', function() {
            clearTimeout(pressTimer);
        });
    });
});
</script>
{% endblock %}